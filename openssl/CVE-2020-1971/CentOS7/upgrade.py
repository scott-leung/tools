#!/usr/bin/python
#coding=utf-8
import sys
import os
import commands
import urllib

if sys.version_info >= (3, 0):
    sys.stdout.write("Need python 2.x to run.\n")
    sys.exit(1)

if os.geteuid() != 0:
    print '运行该脚本需要 root 身份'
    sys.exit(1)

print '''
[----------------------------------------说明----------------------------------------]
漏洞编号：CVE-2020-1971
漏洞说明：参考【https://s.tencent.com/research/bsafe/1193.html】

漏洞描述：

2020年12月08日，OpenSSL官方发布安全公告，披露CVE-2020-1971 OpenSSL GENERAL_NAME_cmp拒绝服务漏洞。
当两个GENERAL_NAME都包含同一个EDIPARTYNAME时，由于GENERAL_NAME_cmp函数未能正确处理，
从而导致空指针引用，并可能导致拒绝服务。

OpenSSL是一个开放源代码的软件库包，应用程序可以使用这个包来进行安全通信，避免窃听，
同时确认另一端连接者的身份。
这个包广泛被应用在互联网的网页服务器上。

漏洞等级：高危

受影响的版本：
OpenSSL 1.1.1 ～ 1.1.1h

OpenSSL 1.0.2 ～ 1.0.2w

安全版本：
OpenSSL 1.1.1i

OpenSSL 1.0.2x
[--------------------------------------说明结束--------------------------------------]
'''

(status, output) = commands.getstatusoutput("openssl version")

version = output.split(' ')[1]
print '\033[32m当前OpenSSL版本：' + version + '\033[0m'

if version == '1.1.1i' or version == '1.0.2x':
    print '\n\033[32m恭喜您，当前版本暂时为安全版本！\033[0m\n'
    sys.exit(1)

ans = raw_input('当前版本非指定安全版本，是否确认自动升级至 \033[32m1.1.1i\033[0m ?（y/N）')
if ans.upper() != 'Y':
    print '\n\033[32m自动升级已取消\033[0m\n'
    sys.exit(1)

installPath = raw_input('请输入软件下载路径：(/data/software/)')

if len(installPath) == 0:
    installPath = '/data/software/'

if not os.path.exists(installPath):
    os.makedirs(installPath)

cmd = 'cd ' + installPath + '&& wget "https://www.openssl.org/source/openssl-1.1.1i.tar.gz" && tar -zxf openssl-1.1.1i.tar.gz'

print 'downloading and unzipping...\n'

(status, output) = commands.getstatusoutput(cmd)

print 'download package status: ' + bytes(status)

cmd = 'cd ' + installPath + '/openssl-1.1.1i && ./config --prefix=/usr/local/openssl && make && make install'

print 'compiling and installing...\n'
(status, output) = commands.getstatusoutput(cmd)

print 'config and install status: ' + bytes(status)

print '编译安装成功，下面将进行版本替换...'

cmd = (
    'mv /usr/bin/openssl /usr/bin/openssl.old && '
    'mv /usr/lib64/openssl /usr/lib64/openssl.old && '
    'mv /usr/lib64/libssl.so /usr/lib64/libssl.so.old && '
    'ln -s /usr/local/openssl/bin/openssl /usr/bin/openssl && '
    'ln -s /usr/local/openssl/include/openssl /usr/include/openssl && '
    'ln -s /usr/local/openssl/lib/libssl.so /usr/lib64/libssl.so && '
    'echo "/usr/local/openssl/lib" >> /etc/ld.so.conf && '
    'ldconfig -v'
)

(status, output) = commands.getstatusoutput(cmd)

print '版本替换脚本完成，将进行版本检查...'

(status, output) = commands.getstatusoutput("openssl version")

version = output.split(' ')[1]

print '当前OpenSSL版本为：' + version

if version == '1.1.1i' or version == '1.0.2x':
    print '\n\033[32m恭喜您，版本更新成功！\033[0m\n'
    sys.exit(1)

print '\n版本更新失败，请检查或联系脚本作者...\n'
